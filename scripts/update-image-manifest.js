const fs = require("fs");
const path = require("path");

const repoRoot = path.resolve(__dirname, "..");
const assetsDir = path.join(repoRoot, "assets");
const outputPath = path.join(assetsDir, "image-manifest.ts");
const dataPath = path.join(assetsDir, "data", "data.json");

const imageExtensions = new Set([".jpg", ".jpeg", ".png", ".webp"]);

const listImages = (subdir) => {
  const dirPath = path.join(assetsDir, subdir);
  return fs
    .readdirSync(dirPath, { withFileTypes: true })
    .filter((entry) => entry.isFile())
    .map((entry) => entry.name)
    .filter((name) => imageExtensions.has(path.extname(name).toLowerCase()))
    .sort((a, b) => a.localeCompare(b));
};

const buildReferencedImages = () => {
  if (!fs.existsSync(dataPath)) {
    return new Set();
  }
  const data = JSON.parse(fs.readFileSync(dataPath, "utf8"));
  const referenced = new Set();
  const addUri = (uri) => {
    if (typeof uri === "string" && uri.startsWith("assets/")) {
      referenced.add(uri);
    }
  };
  if (Array.isArray(data.cocktails)) {
    data.cocktails.forEach((cocktail) => addUri(cocktail?.photoUri));
  }
  if (Array.isArray(data.ingredients)) {
    data.ingredients.forEach((ingredient) => addUri(ingredient?.photoUri));
  }
  return referenced;
};

const pruneUnusedImages = () => {
  const referenced = buildReferencedImages();
  if (referenced.size === 0) {
    console.log("No referenced images found in assets/data/data.json.");
    return;
  }
  const subdirs = ["ingredients", "cocktails"];
  subdirs.forEach((subdir) => {
    const files = listImages(subdir);
    files.forEach((file) => {
      const uri = `assets/${subdir}/${file}`;
      if (!referenced.has(uri)) {
        fs.unlinkSync(path.join(assetsDir, subdir, file));
        console.log(`Removed ${uri}`);
      }
    });
  });
};

const renderImageMap = (constName, subdir, files) =>
  [
    `export const ${constName}Images: Record<string, number> = {`,
    ...files.map(
      (file) => `  'assets/${subdir}/${file}': require('./${subdir}/${file}'),`,
    ),
    "};",
    "",
  ].join("\n");

const renderGlasswareUriById = (files) =>
  [
    "export const glasswareUriById: Record<string, string> = {",
    ...files.map(
      (file) =>
        `  '${path.basename(file, path.extname(file))}': 'assets/glassware/${file}',`,
    ),
    "};",
    "",
  ].join("\n");

if (process.argv.includes("--prune-unused")) {
  pruneUnusedImages();
}

const ingredientFiles = listImages("ingredients");
const glasswareFiles = listImages("glassware");
const cocktailFiles = listImages("cocktails");

const contents = [
  "// Auto-generated by scripts/update-image-manifest.js.",
  "/* eslint-disable @typescript-eslint/no-var-requires */",
  renderImageMap("ingredient", "ingredients", ingredientFiles),
  renderImageMap("glassware", "glassware", glasswareFiles),
  renderGlasswareUriById(glasswareFiles),
  "export function resolveGlasswareUriFromId(glassId?: string | null) {",
  "  if (!glassId) {",
  "    return undefined;",
  "  }",
  "  return glasswareUriById[glassId] ?? undefined;",
  "}",
  "",
  renderImageMap("cocktail", "cocktails", cocktailFiles),
  "export function resolveAssetFromCatalog(uri?: string | null) {",
  "  if (!uri) {",
  "    return undefined;",
  "  }",
  "  if (uri in ingredientImages) {",
  "    return ingredientImages[uri as keyof typeof ingredientImages];",
  "  }",
  "  if (uri in cocktailImages) {",
  "    return cocktailImages[uri as keyof typeof cocktailImages];",
  "  }",
  "  if (uri in glasswareImages) {",
  "    return glasswareImages[uri as keyof typeof glasswareImages];",
  "  }",
  "  return undefined;",
  "}",
  "",
].join("\n");

fs.writeFileSync(outputPath, contents);
console.log(`Updated ${path.relative(repoRoot, outputPath)}`);
