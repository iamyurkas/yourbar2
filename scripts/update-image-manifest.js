const fs = require('fs');
const path = require('path');

const repoRoot = path.resolve(__dirname, '..');
const assetsDir = path.join(repoRoot, 'assets');
const outputPath = path.join(assetsDir, 'image-manifest.ts');

const imageExtensions = new Set(['.jpg', '.jpeg', '.png', '.webp']);

const glasswareIdMap = [
  ['bowl', 'bowl.jpg'],
  ['champagne_flute', 'champagne.jpg'],
  ['cocktail_glass', 'cocktail.jpg'],
  ['collins_glass', 'collins.jpg'],
  ['copper_mug', 'copper.jpg'],
  ['coupe', 'coupe.jpg'],
  ['cup', 'cup.jpg'],
  ['goblet', 'goblet.jpg'],
  ['highball_glass', 'highball.jpg'],
  ['hurricane_glass', 'hurricane.jpg'],
  ['irish_coffee_glass', 'irish.jpg'],
  ['margarita_glass', 'margarita.jpg'],
  ['nick_and_nora', 'nick.jpg'],
  ['pitcher', 'pitcher.jpg'],
  ['pub_glass', 'pub.jpg'],
  ['rocks_glass', 'rocks.jpg'],
  ['shooter', 'shooter.jpg'],
  ['snifter', 'snifter.jpg'],
  ['tiki', 'tiki.jpg'],
  ['wine_glass', 'wine.jpg'],
];

const listImages = (subdir) => {
  const dirPath = path.join(assetsDir, subdir);
  return fs
    .readdirSync(dirPath, { withFileTypes: true })
    .filter((entry) => entry.isFile())
    .map((entry) => entry.name)
    .filter((name) => imageExtensions.has(path.extname(name).toLowerCase()))
    .sort((a, b) => a.localeCompare(b));
};

const renderImageMap = (constName, subdir, files) =>
  [
    `export const ${constName}Images: Record<string, number> = {`,
    ...files.map(
      (file) =>
        `  'assets/${subdir}/${file}': require('./${subdir}/${file}'),`
    ),
    '};',
    '',
  ].join('\n');

const renderGlasswareUriById = () =>
  [
    'export const glasswareUriById: Record<string, string> = {',
    ...glasswareIdMap.map(
      ([id, filename]) => `  ${id}: 'assets/glassware/${filename}',`
    ),
    '};',
    '',
  ].join('\n');

const ingredientFiles = listImages('ingredients');
const glasswareFiles = listImages('glassware');
const cocktailFiles = listImages('cocktails');

const contents = [
  '// Auto-generated by scripts/update-image-manifest.js.',
  '/* eslint-disable @typescript-eslint/no-var-requires */',
  renderImageMap('ingredient', 'ingredients', ingredientFiles),
  renderImageMap('glassware', 'glassware', glasswareFiles),
  renderGlasswareUriById(),
  'export function resolveGlasswareUriFromId(glassId?: string | null) {',
  '  if (!glassId) {',
  '    return undefined;',
  '  }',
  '  return glasswareUriById[glassId] ?? undefined;',
  '}',
  '',
  renderImageMap('cocktail', 'cocktails', cocktailFiles),
  'export function resolveAssetFromCatalog(uri?: string | null) {',
  '  if (!uri) {',
  '    return undefined;',
  '  }',
  '  if (uri in ingredientImages) {',
  '    return ingredientImages[uri as keyof typeof ingredientImages];',
  '  }',
  '  if (uri in cocktailImages) {',
  '    return cocktailImages[uri as keyof typeof cocktailImages];',
  '  }',
  '  if (uri in glasswareImages) {',
  '    return glasswareImages[uri as keyof typeof glasswareImages];',
  '  }',
  '  return undefined;',
  '}',
  '',
].join('\n');

fs.writeFileSync(outputPath, contents);
console.log(`Updated ${path.relative(repoRoot, outputPath)}`);
